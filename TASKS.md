# RAG システム改善 タスクリスト

## フェーズ 1: 基盤改善 (検索精度向上)

### 1. FAQ データチャンキング戦略の策定と実装
    - [X] **調査・設計:**
        - [X] チャンク化の単位決定（例: 質問 + 回答1段落、≈400トークン目標）
        - [X] チャンク境界の定義方法（例: 改行、特定の区切り文字）
        - [X] メタデータ（カテゴリ、タグ）の付与戦略決定 (一旦保留)
        - [X] 既存データ移行計画の策定 (スクリプトによる新規テーブルへの投入)
    - [X] **実装:**
        - [X] FAQデータをチャンキングする前処理スクリプト（Deno）を作成 (`scripts/chunk_and_embed_faq.ts`)
        - [X] チャンク化されたデータを格納するための新しいSupabaseテーブルスキーマ定義 (`faq_chunks`)
        - [X] 既存FAQデータを新スキーマに移行するスクリプト作成・実行
        - [ ] 新規FAQデータ取り込み時のチャンキング処理組み込み（既存の取り込みプロセスがあれば修正）<- これは新規FAQ投入プロセス次第
    - [ ] **テスト:**
        - [ ] チャンキング処理が意図通り動作することを確認
        - [ ] 移行データの内容を確認

### 2. ハイブリッド検索の実装 (ベクトル検索 + キーワード検索)
    - [ ] **調査・設計:**
        - [X] PostgreSQL全文検索 (`pg_trgm`) の利用方法調査 (日本語対応含む)
        - [ ] ベクトル検索スコア (cosine類似度) とキーワード検索スコア (`pg_trgm` 類似度) の統合方法検討 (重み付け係数決定: 例 0.6 / 0.4)
        - [ ] Supabase Function (RPC) でベクトル検索とキーワード検索を同時に実行し、スコアを統合するロジック設計
    - [ ] **実装:**
        - [X] `faq_chunks` テーブルに全文検索用インデックス (`pg_trgm` GIN) を追加
        - [ ] ベクトル検索とキーワード検索を実行し、結果を統合するSupabase Function (RPC) を作成または修正 (例: `hybrid_search_faq_chunks`)
        - [ ] Channelio Webhook Handler (`index.ts`) から新しいRPCを呼び出すように修正
    - [ ] **テスト:**
        - [ ] 様々なクエリ（同義語、表記揺れ含む）で検索精度が向上することを確認
        - [ ] スコア統合ロジックと重み付けが期待通り機能することを確認

## フェーズ 2: 応答品質向上と応用

### 3. HyDE (Hypothetical Document Embeddings) の導入
    - [ ] **調査・設計:**
        - [ ] HyDE の効果と実装方法の再確認
        - [ ] Channelio Webhook Handler (`index.ts`) 内で、ユーザー質問から疑似文書を生成するプロンプト設計 (OpenAI API呼び出し)
    - [ ] **実装:**
        - [ ] `index.ts` に OpenAI API (Chat Completions) を呼び出して疑似文書を生成する処理を追加
        - [ ] 生成された疑似文書の Embedding を取得する処理を追加 (OpenAI Embeddings API)
        - [ ] 取得した Embedding を使ってハイブリッド検索 (RPC) を実行するように修正
    - [ ] **テスト:**
        - [ ] HyDE導入前後で、特に抽象的または長文の質問に対する検索精度が向上するか評価

### 4. プロンプトエンジニアリングによる応答文体改善
    - [ ] **調査・設計:**
        - [ ] AAAフレームワーク（共感→回答→気遣い）に基づいた具体的なシステムプロンプト文案作成
        - [ ] 生成温度などのパラメータ調整方針検討 (例: 温度0.7で草稿→温度0.3でリライトは高度なため、まずは単一生成で調整)
    - [ ] **実装:**
        - [ ] `index.ts` 内の OpenAI API (Chat Completions) 呼び出し箇所で、システムプロンプトを修正
        - [ ] 必要に応じて生成パラメータ (temperature等) を調整
    - [ ] **テスト:**
        - [ ] 生成される回答のトーンがより温かく、丁寧になることを確認
        - [ ] AAAフレームワークが応答に反映されているか確認

### 5. (任意) 高性能モデルへの切り替え検討
    - [ ] **評価:**
        - [ ] GPT-3.5-turbo での改善限界を評価
        - [ ] GPT-4o などの上位モデル利用時のコストと性能向上のトレードオフを評価
    - [ ] **実装 (実施する場合):**
        - [ ] `index.ts` 内のモデル指定箇所 (`gpt-3.5-turbo`) を変更

## フェーズ 3: 評価と継続的改善

### 6. 評価指標の定義と計測設定
    - [ ] **設計:**
        - [ ] 評価指標の具体化 (例: Top-3 検索ヒット率、回答のHelpful/Warmthスコア評価方法)
        - [ ] ユーザー問い合わせ、検索結果、生成回答、ユーザーフィードバック（もしあれば）を記録するログテーブルスキーマ設計 (Supabase)
        - [ ] スコア計測方法の検討（手動評価 or 自動評価の一部導入）
    - [ ] **実装:**
        - [ ] `index.ts` にログデータをSupabaseテーブルに保存する処理を追加
        - [ ] 定期的にログを集計・分析する仕組みを検討（手動 or 簡単なスクリプト）
    - [ ] **テスト:**
        - [ ] ログが正しく記録されることを確認

### 7. ドキュメント更新
    - [ ] README.md に以下を追記・更新:
        - [ ] 新しいアーキテクチャ概要 (チャンキング、ハイブリッド検索)
        - [ ] 新しく追加された環境変数
        - [ ] データ投入・前処理スクリプトの実行方法
        - [ ] 新しいSupabaseテーブルスキーマとRPC
        - [ ] 評価指標とログの確認方法
    - [ ] `TASKS.md` の完了ステータスを更新 